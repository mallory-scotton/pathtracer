///////////////////////////////////////////////////////////////////////////////
// Header guard
///////////////////////////////////////////////////////////////////////////////
#pragma once

///////////////////////////////////////////////////////////////////////////////
// Dependencies
///////////////////////////////////////////////////////////////////////////////
#include <map>
#include "Components/Mesh.hpp"
#include "Acceleration/BoundingHierarchy.hpp"


///////////////////////////////////////////////////////////////////////////////
// Namespace Ray
///////////////////////////////////////////////////////////////////////////////
namespace Ray
{

///////////////////////////////////////////////////////////////////////////////
/// \brief
///
///////////////////////////////////////////////////////////////////////////////
class BoundingTranslator
{
public:
    ///////////////////////////////////////////////////////////////////////////
    //
    ///////////////////////////////////////////////////////////////////////////
    struct Node
    {
        Vec3f bboxmin;      //<!
        Vec3f bboxmax;      //<!
        Vec3f LRLeaf;       //<!
    };
    int topLevelIndex;
    std::vector<Node> nodes;
    int nodeTexWidth;

private:
    ///////////////////////////////////////////////////////////////////////////
    //
    ///////////////////////////////////////////////////////////////////////////
    int curNode;
    int curTriIndex;
    std::vector<int> bvhRootStartIndices;
    std::vector<Ray::MeshInstance> meshInstances;
    std::vector<Ray::Mesh*> meshes;
    const BoundingHierarchy topLevelBvh;

public:
    ///////////////////////////////////////////////////////////////////////////
    /// \brief
    ///
    ///////////////////////////////////////////////////////////////////////////
    BoundingTranslator();

    ///////////////////////////////////////////////////////////////////////////
    /// \brief
    ///
    ///////////////////////////////////////////////////////////////////////////
    ~BoundingTranslator();


public:
    ///////////////////////////////////////////////////////////////////////////
    /// \brief
    ///
    ///////////////////////////////////////////////////////////////////////////
    void ProcessBLAS();

    ///////////////////////////////////////////////////////////////////////////
    /// \brief
    ///
    ///////////////////////////////////////////////////////////////////////////
    void ProcessTLAS();

    ///////////////////////////////////////////////////////////////////////////
    /// \brief
    ///
    /// \param topLevelBvh
    /// \param instances
    ///
    ///////////////////////////////////////////////////////////////////////////
    void UpdateTLAS(const BoundingHierarchy& topLevelBvh,
                    const std::vector<Ray::MeshInstance>& instances);

    ///////////////////////////////////////////////////////////////////////////
    /// \brief
    ///
    /// \param topLevelBvh
    /// \param meshes
    /// \param instances
    ///
    ///////////////////////////////////////////////////////////////////////////
    void Process(const BoundingHierarchy& topLevelBvh,
        const std::vector<Ray::Mesh*>& meshes,
        const std::vector<Ray::MeshInstance>& instances);

private:
    ///////////////////////////////////////////////////////////////////////////
    /// \brief
    ///
    /// \param nodeIdx
    /// \param bvh
    ///
    ///////////////////////////////////////////////////////////////////////////
    int ProcessBLASNodes(int nodeIdx, const BoundingHierarchy& bvh);

    ///////////////////////////////////////////////////////////////////////////
    /// \brief
    ///
    /// \param nodeIdx
    /// \param bvh
    ///
    ///////////////////////////////////////////////////////////////////////////
    int ProcessTLASNodes(int nodeIdx, const BoundingHierarchy& bvh);
};

}  // namespace Ray
